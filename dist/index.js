var Pe=Object.create;var j=Object.defineProperty;var Ve=Object.getOwnPropertyDescriptor;var Ae=Object.getOwnPropertyNames;var De=Object.getPrototypeOf,ve=Object.prototype.hasOwnProperty;var be=(n,e)=>()=>(n&&(e=n(n=0)),e);var W=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),Ee=(n,e)=>{for(var t in e)j(n,t,{get:e[t],enumerable:!0})},se=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ae(e))!ve.call(n,s)&&s!==t&&j(n,s,{get:()=>e[s],enumerable:!(r=Ve(e,s))||r.enumerable});return n};var E=(n,e,t)=>(t=n!=null?Pe(De(n)):{},se(e||!n||!n.__esModule?j(t,"default",{value:n,enumerable:!0}):t,n)),Ie=n=>se(j({},"__esModule",{value:!0}),n);var h,u,Te,c=be(()=>{h=require("buffer"),u=E(require("process")),Te=function(n){function e(){var r=this||self;return delete n.prototype.__magic__,r}if(typeof globalThis=="object")return globalThis;if(this)return e();n.defineProperty(n.prototype,"__magic__",{configurable:!0,get:e});var t=__magic__;return t}(Object)});var me=W((xt,le)=>{"use strict";c();var de=Object.getOwnPropertySymbols,xe=Object.prototype.hasOwnProperty,Ce=Object.prototype.propertyIsEnumerable;function $e(n){if(n==null)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(n)}function ke(){try{if(!Object.assign)return!1;var n=new String("abc");if(n[5]="de",Object.getOwnPropertyNames(n)[0]==="5")return!1;for(var e={},t=0;t<10;t++)e["_"+String.fromCharCode(t)]=t;var r=Object.getOwnPropertyNames(e).map(function(o){return e[o]});if(r.join("")!=="0123456789")return!1;var s={};return"abcdefghijklmnopqrst".split("").forEach(function(o){s[o]=o}),Object.keys(Object.assign({},s)).join("")==="abcdefghijklmnopqrst"}catch{return!1}}le.exports=ke()?Object.assign:function(n,e){for(var t,r=$e(n),s,o=1;o<arguments.length;o++){t=Object(arguments[o]);for(var d in t)xe.call(t,d)&&(r[d]=t[d]);if(de){s=de(t);for(var l=0;l<s.length;l++)Ce.call(t,s[l])&&(r[s[l]]=t[s[l]])}}return r}});var ue=W((Ct,q)=>{"use strict";c();q.exports=Fe;q.exports.append=he;var Oe=/^[!#$%&'*+\-.^_`|~0-9A-Za-z]+$/;function he(n,e){if(typeof n!="string")throw new TypeError("header argument is required");if(!e)throw new TypeError("field argument is required");for(var t=Array.isArray(e)?e:pe(String(e)),r=0;r<t.length;r++)if(!Oe.test(t[r]))throw new TypeError("field argument contains an invalid header name");if(n==="*")return n;var s=n,o=pe(n.toLowerCase());if(t.indexOf("*")!==-1||o.indexOf("*")!==-1)return"*";for(var d=0;d<t.length;d++){var l=t[d].toLowerCase();o.indexOf(l)===-1&&(o.push(l),s=s?s+", "+t[d]:t[d])}return s}function pe(n){for(var e=0,t=[],r=0,s=0,o=n.length;s<o;s++)switch(n.charCodeAt(s)){case 32:r===e&&(r=e=s+1);break;case 44:t.push(n.substring(r,e)),r=e=s+1;break;default:e=s+1;break}return t.push(n.substring(r,e)),t}function Fe(n,e){if(!n||!n.getHeader||!n.setHeader)throw new TypeError("res argument is required");var t=n.getHeader("Vary")||"",r=Array.isArray(t)?t.join(", "):String(t);(t=he(r,e))&&n.setHeader("Vary",t)}});var ge=W(($t,fe)=>{c();(function(){"use strict";var n=me(),e=ue(),t={origin:"*",methods:"GET,HEAD,PUT,PATCH,POST,DELETE",preflightContinue:!1,optionsSuccessStatus:204};function r(i){return typeof i=="string"||i instanceof String}function s(i,a){if(Array.isArray(a)){for(var m=0;m<a.length;++m)if(s(i,a[m]))return!0;return!1}else return r(a)?i===a:a instanceof RegExp?a.test(i):!!a}function o(i,a){var m=a.headers.origin,g=[],p;return!i.origin||i.origin==="*"?g.push([{key:"Access-Control-Allow-Origin",value:"*"}]):r(i.origin)?(g.push([{key:"Access-Control-Allow-Origin",value:i.origin}]),g.push([{key:"Vary",value:"Origin"}])):(p=s(m,i.origin),g.push([{key:"Access-Control-Allow-Origin",value:p?m:!1}]),g.push([{key:"Vary",value:"Origin"}])),g}function d(i){var a=i.methods;return a.join&&(a=i.methods.join(",")),{key:"Access-Control-Allow-Methods",value:a}}function l(i){return i.credentials===!0?{key:"Access-Control-Allow-Credentials",value:"true"}:null}function V(i,a){var m=i.allowedHeaders||i.headers,g=[];return m?m.join&&(m=m.join(",")):(m=a.headers["access-control-request-headers"],g.push([{key:"Vary",value:"Access-Control-Request-Headers"}])),m&&m.length&&g.push([{key:"Access-Control-Allow-Headers",value:m}]),g}function D(i){var a=i.exposedHeaders;if(a)a.join&&(a=a.join(","));else return null;return a&&a.length?{key:"Access-Control-Expose-Headers",value:a}:null}function f(i){var a=(typeof i.maxAge=="number"||i.maxAge)&&i.maxAge.toString();return a&&a.length?{key:"Access-Control-Max-Age",value:a}:null}function S(i,a){for(var m=0,g=i.length;m<g;m++){var p=i[m];p&&(Array.isArray(p)?S(p,a):p.key==="Vary"&&p.value?e(a,p.value):p.value&&a.setHeader(p.key,p.value))}}function M(i,a,m,g){var p=[],_=a.method&&a.method.toUpperCase&&a.method.toUpperCase();_==="OPTIONS"?(p.push(o(i,a)),p.push(l(i,a)),p.push(d(i,a)),p.push(V(i,a)),p.push(f(i,a)),p.push(D(i,a)),S(p,m),i.preflightContinue?g():(m.statusCode=i.optionsSuccessStatus,m.setHeader("Content-Length","0"),m.end())):(p.push(o(i,a)),p.push(l(i,a)),p.push(D(i,a)),S(p,m),g())}function v(i){var a=null;return typeof i=="function"?a=i:a=function(m,g){g(null,i)},function(g,p,_){a(g,function(re,ye){if(re)_(re);else{var O=n({},t,ye),J=null;O.origin&&typeof O.origin=="function"?J=O.origin:O.origin&&(J=function(B,L){L(null,O.origin)}),J?J(g.headers.origin,function(B,L){B||!L?_(B):(O.origin=L,M(O,g,p,_))}):_()}})}}fe.exports=v})()});var _e={};Ee(_e,{AskUI:()=>K,BadState:()=>y,DatabaseError:()=>x,Directions:()=>b,ISPDemoServer:()=>te,InvalidArgument:()=>A,InvalidFile:()=>F,NotFound:()=>X,NotImplemented:()=>P,Process:()=>N,ProcessFile:()=>$,ProcessHandler:()=>T,ProcessStep:()=>k,ProcessingError:()=>I,ProcessingSystem:()=>H,SystemError:()=>G,TextFileProcessHandler:()=>Z,defaultConnector:()=>Q,router:()=>Y});module.exports=Ie(_e);c();c();c();var I=class extends Error{},F=class extends I{},A=class extends I{},y=class extends I{},P=class extends I{},X=class extends I{},x=class extends I{},G=class extends I{},K=class extends Error{constructor(t){super("Need more information from UI.");this.element=t}};c();c();var ne=E(require("csv-parse"));c();var T=class{constructor(e){this.name=e}connect(e){this.system=e}canHandle(e){throw new P(`A handler '${this.name}' cannot check file '${e.name}', since canHandle() is not implemented.`)}canAppend(e){throw new P(`A handler '${this.name}' cannot append file '${e.name}', since canAppend() is not implemented.`)}checkCompletion(e){throw new P(`A handler '${this.name}' cannot check state '${JSON.stringify(e)}', since checkCompletion() is not implemented.`)}async action(e,t,r,s){throw new P(`A handler '${this.name}' for files ${s.map(o=>`'${o}''`).join(", ")} does not implement action()`)}startingState(e){throw new P(`A handler '${this.name}' for file ${e.map(t=>`'${t}''`).join(", ")} does not implement startingState()`)}async getDirections(e,t){throw new P(`A handler '${this.name}' for state '${JSON.stringify(e)}' does not implement getDirections()`)}async rollback(e){throw new P(`A handler '${this.name}' for step '${e}' does not implement rollback()`)}};var C=require("interactive-elements"),Z=class extends T{startingState(e){let t={};for(let r of e)t[r.name]={lines:r.decode().replace(/\n+$/,"").split(`
`).map((s,o)=>({text:s,line:o,columns:{}}))};return{stage:"initial",files:t}}checkCompletion(e){if(e.stage==="executed")return!0}async needInputForSegmentation(e,t){return!1}async needInputForClassification(e,t){return!1}async needInputForAnalysis(e,t){return!1}async needInputForExecution(e,t){return!1}async getDirections(e,t){let r,s;switch(e.stage){case"initial":if(r=await this.needInputForSegmentation(e,t),r)return r;s=new b({type:"action",action:{op:"segmentation"}});break;case"segmented":if(r=await this.needInputForClassification(e,t),r)return r;s=new b({type:"action",action:{op:"classification"}});break;case"classified":if(r=await this.needInputForAnalysis(e,t),r)return r;s=new b({type:"action",action:{op:"analysis"}});break;case"analyzed":if(r=await this.needInputForExecution(e,t),r)return r;s=new b({type:"action",action:{op:"execution"}});break;default:throw new y("Cannot find directions from the current state.")}return s}async action(e,t,r,s){if(!(0,C.isImportAction)(t))throw new y(`Action is not import action ${JSON.stringify(t)}`);if((0,C.isImportOpAction)(t))switch(t.op){case"analysis":case"classification":case"segmentation":case"execution":return this[t.op](e,r,s,e.config);default:throw new y(`Cannot parse action ${JSON.stringify(t)}`)}if((0,C.isImportConfigureAction)(t)&&(Object.assign(e.config,t.configure),await e.save()),(0,C.isImportAnswerAction)(t)){e.config.answers||(e.config.answers={});let o=e.config.answers;for(let d of Object.keys(t.answer)){o[d]=o[d]||{};for(let l of Object.keys(t.answer[d]))o[d][l]=t.answer[d][l]}await e.save()}return r}async segmentation(e,t,r,s){throw new P(`A class ${this.constructor.name} does not implement segmentation().`)}async classification(e,t,r,s){throw new P(`A class ${this.constructor.name} does not implement classification().`)}async analysis(e,t,r,s){throw new P(`A class ${this.constructor.name} does not implement analysis().`)}async execution(e,t,r,s){throw new P(`A class ${this.constructor.name} does not implement execution().`)}async parseLine(e,t={}){return new Promise((r,s)=>{(0,ne.default)(e,{delimiter:t.columnSeparator||",",skip_lines_with_error:!!t.skipErrors},function(o,d){o?s(o):r(d[0])})})}async parseCSV(e,t={}){let r=[],s=t.cutFromBeginning||0,o=!0;for(let l of Object.keys(e.files))for(let V=0;V<e.files[l].lines.length;V++){if(s){s--;continue}let D={...e.files[l].lines[V]},f=t.trimLines?D.text.trim():D.text;if(o)if(o=!1,t.useFirstLineHeadings){r=await this.parseLine(f,t);let v={};for(let i=0;i<r.length;i++)v[r[i]]=v[r[i]]||0,v[r[i]]++,v[r[i]]>1&&(r[i]=`${r[i]}${v[r[i]]}`);continue}else{let v=(await this.parseLine(f,t)).length;for(let i=0;i<v;i++)r.push(`${i}`)}let S={},M=f.trim()!==""?await this.parseLine(f,t):null;M&&(M.forEach((v,i)=>{i<r.length?S[r[i]]=v:(S["+"]=S["+"]||"",S["+"]+=v+`
`)}),D.columns=S,e.files[l].lines[V]=D)}return{...e,stage:"segmented"}}};c();c();var b=class{constructor(e){this.type=e.type,this.element=e.element,this.action=e.action}toJSON(){let e={type:this.type};return this.element&&(e.element=this.element),this.action&&(e.action=this.action),e}isImmediate(){return this.type==="action"}isComplete(){return this.type==="complete"}};c();var U=E(require("clone"));c();var oe=E(require("chardet")),ie=E(require("clone"));var $=class{constructor(e){this.id=null,this.processId=e.processId||null,this.name=e.name,this.type=e.type,this.encoding=e.encoding,this.data=e.data,this._decoded=void 0}toString(){return`ProcessFile #${this.id} ${this.name}`}toJSON(){return{processId:this.processId,name:this.name,type:this.type,encoding:this.encoding,data:this.data}}async save(e){let t=this.toJSON();if(this.encoding==="json"&&(t.data=JSON.stringify(t.data)),this.id)return await e("process_files").update(t).where({id:this.id}),this.id;if(this.id=(await e("process_files").insert(t).returning("id"))[0].id,this.id)return this.id;throw new x(`Saving process ${JSON.stringify(t)} failed.`)}firstLineMatch(e){let t=this.decode(),r=t.indexOf(`
`),s=r<0?t:t.substr(0,r).trim();return e.test(s)}secondLineMatch(e){let t=this.decode().split(`
`);return t.length>1&&e.test(t[1].trim())}thirdLineMatch(e){let t=this.decode().split(`
`);return t.length>2&&e.test(t[2].trim())}isTextFile(){return this.type?.startsWith("text/")||!1}parseEncoding(e){switch(e.toUpperCase()){case"UTF-8":return"utf-8";case"ISO-8859-1":return"latin1";case"UTF-16LE":return"utf16le";default:throw new F(`Not able to map text encoding ${e}.`)}}decode(){if(this._decoded)return this._decoded;switch(this.encoding){case"base64":let e=h.Buffer.from(this.data,"base64"),t=oe.default.detect(e);if(!t)throw new F(`Cannot determine encoding for '${this}'.`);return this._decoded=e.toString(this.parseEncoding(t)),this._decoded;case"utf-8":return this._decoded=(0,ie.default)(this.data),this._decoded;default:throw new F(`An encoding '${this.encoding}' is not yet supported.`)}}};c();var k=class{constructor(e){this.processId=e.processId||null,this.number=e.number,this.state=e.state,this.handler=e.handler,this.directions=e.directions?new b(e.directions):void 0,this.action=e.action,this.started=e.started,this.finished=e.finished}toString(){return`ProcessStep ${this.number} of Process #${this.processId}`}get db(){return this.process.db}async save(){if(this.id)return await this.db("process_steps").update(this.toJSON()).where({id:this.id}),this.id;if(this.started=new Date,this.id=(await this.db("process_steps").insert(this.toJSON()).returning("id"))[0].id,this.id)return this.id;throw new x(`Saving process ${JSON.stringify(this.toJSON)} failed.`)}toJSON(){return{processId:this.processId,number:this.number,state:this.state,directions:this.directions,handler:this.handler,action:this.action,started:this.started,finished:this.finished}}async setDirections(e,t){this.directions=t,await e("process_steps").update({directions:t.toJSON()}).where({id:this.id})}};var N=class{constructor(e,t,r={}){this.system=e,this.id=null,this.config=r,this.name=t||"[no name]",this.complete=!1,this.successful=void 0,this.files=[],this.steps=[],this.currentStep=void 0,this.status="INCOMPLETE"}toString(){return`Process #${this.id} ${this.name}`}toJSON(){return{name:this.name,config:this.config,complete:this.complete,successful:this.successful,currentStep:this.currentStep,status:this.status,error:this.error}}addFile(e){e.processId=this.id,this.files.push(e)}async addStep(e){e.processId=this.id,e.process=this,this.steps.push(e)}async getCurrentStep(){if(this.currentStep===null||this.currentStep===void 0)throw new y(`Process #${this.id} ${this.name} has invalid current step.`);return this.steps[this.currentStep]?this.steps[this.currentStep]:this.loadStep(this.currentStep)}async proceedToState(e,t){let r=await this.getCurrentStep(),s=this.system.getHandler(r.handler);r.action=e,r.finished=new Date,r.save();let o=new k({number:r.number+1,state:t,handler:s.name});this.addStep(o),this.currentStep=(this.currentStep||0)+1,this.system.logger.info(`Proceeding ${this} to new step ${this.currentStep}.`),this.save(),await o.save(),await this.system.checkFinishAndFindDirections(s,o)}get db(){return this.system.db}async save(){if(this.id)return await this.db("processes").update(this.toJSON()).where({id:this.id}),this.id;if(this.id=(await this.db("processes").insert(this.toJSON()).returning("id"))[0].id,this.id)return this.id;throw new x(`Saving process ${JSON.stringify(this.toJSON)} failed.`)}async load(e){let t=await this.db("processes").select("*").where({id:e}).first();if(!t)throw new A(`Cannot find process #${e}`);Object.assign(this,t),this.id=e,this.files=(await this.db("process_files").select("*").where({processId:this.id})).map(r=>{let s=new $(r);return s.id=r.id,s}),await this.getCurrentStep()}async loadStep(e){if(!this.id)throw new y(`Cannot load steps, if the process have no ID ${JSON.stringify(this.toJSON())}.`);if(this.currentStep===void 0)throw new y(`Cannot load any steps, since process have no current step ${JSON.stringify(this.toJSON())}.`);let t=await this.db("process_steps").where({processId:this.id,number:e}).first();if(!t)throw new y(`Cannot find step ${this.currentStep} for process ${JSON.stringify(this.toJSON())}.`);return this.steps[this.currentStep]=new k(t),this.steps[this.currentStep].id=t.id,this.steps[this.currentStep].process=this,this.steps[this.currentStep]}canRun(){return!this.complete&&(this.status==="INCOMPLETE"||this.status==="WAITING")}async run(){let e,t=100;for(;;){if(t--,t<0){this.system.logger.error(`Maximum number of executions reached for the process ${this}.`);break}if(e=await this.getCurrentStep(),!e.directions){this.system.logger.info(`No new directions for the process ${this}.`);break}if(!e.directions.isImmediate()){this.system.logger.info(`Waiting for more input for the process ${this}.`),await this.updateStatus();break}let r=this.system.getHandler(e.handler),s=(0,U.default)(e.state),o=(0,U.default)(e.directions.action);try{if(o){let d=await r.action(this,o,s,this.files);await this.proceedToState(o,d)}else throw new y(`Process step ${e} has no action.`)}catch(d){return await this.crashed(d)}}}async crashed(e){if("element"in e){let t=new b({type:"ui",element:e.element}),r=await this.getCurrentStep();r.directions=t,await r.save(),await this.updateStatus();return}if(this.system.logger.error(`Processing of ${this} failed:`,e),this.currentStep!==void 0&&this.currentStep!==null){let t=await this.loadStep(this.currentStep);t.finished=new Date,await t.save()}this.error=e.stack?e.stack:`${e.name}: ${e.message}`,await this.save(),await this.updateStatus()}async updateStatus(){let e="INCOMPLETE";if(this.error)e="CRASHED";else{if(this.currentStep===null||this.currentStep===void 0)throw new y(`Cannot check status when there is no current step loaded for ${this}`);let t=this.steps[this.currentStep];t.finished&&(this.successful===!0&&(e="SUCCEEDED"),this.successful===!1&&(e="FAILED")),t.directions&&(e=t.directions.isImmediate()?"INCOMPLETE":"WAITING")}switch(this.status!==e&&this.system.logger.info(`Process ${this} is now ${e}`),this.status=e,await this.db("processes").update({status:e}).where({id:this.id}),e){case"SUCCEEDED":await this.system.connector.success(this.state);break;case"CRASHED":await this.system.connector.fail(this.error);break;case"FAILED":await this.system.connector.fail(this.state);break;default:let t=this.currentStep?this.steps[this.currentStep].directions:null,r=this.currentStep?this.steps[this.currentStep].state:null;await this.system.connector.waiting(r,t)}}get state(){if(this.currentStep===null||this.currentStep===void 0)throw new y(`Cannot check state when there is no current step loaded for ${this}`);return this.steps[this.currentStep].state}async input(e){let t=await this.getCurrentStep(),r=this.system.getHandler(t.handler),s;try{s=await r.action(this,e,(0,U.default)(t.state),this.files)}catch(o){return this.crashed(o)}await this.proceedToState(e,s)}async rollback(){if(this.currentStep===null||this.currentStep===void 0)throw new y("Cannot roll back when there is no current step.");if(this.currentStep<1)throw new y("Cannot roll back when there is only initial step in the process.");let e=await this.getCurrentStep();if(this.system.logger.info(`Attempt of rolling back '${e}' from '${this}'.`),await this.system.getHandler(e.handler).rollback(e)){this.error&&(this.error=void 0),await this.db("process_steps").delete().where({id:e.id}),this.currentStep--,await this.save();let s=await this.getCurrentStep();return s.finished=void 0,await s.save(),await this.updateStatus(),this.system.logger.info(`Roll back of '${this}' to '${s}' successful.`),!0}return this.system.logger.info(`Not able to roll back '${this}'.`),!1}};c();var Q={async initialize(){console.log(new Date,"Connector initialized.")},async applyResult(){return console.log(new Date,"Result received."),{}},async success(){console.log(new Date,"Process completed.")},async waiting(){},async fail(){console.error(new Date,"Process failed.")},async getTranslation(n){return n}};c();var H=class{constructor(e,t){this.handlers={};this.db=e,this.logger={info:(...r)=>console.log(new Date,...r),error:(...r)=>console.error(new Date,...r)},this.connector=t}async getTranslation(e,t){return this.connector.getTranslation(e,t)}register(e){if(!e)throw new A("A handler was undefined.");if(!e.name)throw new A("A handler without name cannot be registered.");if(e.name in this.handlers)throw new A(`The handler '${e.name}' is already defined.`);if(e.name.length>32)throw new A(`The handler name '${e.name}' is too long.`);e.system=this,this.handlers[e.name]=e}async createProcess(e,t,r){let s=new N(this,e,r);if(await s.save(),t.length<1)return await s.crashed(new A("No files given to create a process.")),s;let o=t[0],d=new $(o);s.addFile(d),await d.save(this.db);let l=null;for(let f of Object.values(this.handlers))try{if(f.canHandle(d)){l=f;break}}catch(S){return await s.crashed(S),s}if(!l)return await s.crashed(new A(`No handler found for the file ${o.name} of type ${o.type}.`)),s;for(let f=1;f<t.length;f++){let S=new $(t[f]);if(!l.canAppend(S))return await s.crashed(new A(`The file ${t[f].name} of type ${t[f].type} cannot be appended to handler.`)),s;s.addFile(S),await S.save(this.db)}let V;try{V=l.startingState(s.files)}catch(f){return await s.crashed(f),s}let D=new k({number:0,handler:l.name,state:V});return s.addStep(D),await D.save(),s.currentStep=0,await s.save(),this.logger.info(`Created process ${s}.`),await this.checkFinishAndFindDirections(l,D),s}async checkFinishAndFindDirections(e,t){let r;try{r=e.checkCompletion(t.state)}catch(s){return t.process.crashed(s)}if(r===void 0){let s;try{s=await e.getDirections(t.state,t.process.config)}catch(o){return t.process.crashed(o)}await t.setDirections(this.db,s)}else t.directions=void 0,t.action=void 0,t.finished=new Date,await t.save(),t.process.complete=!0,t.process.successful=r,await t.process.save();await t.process.updateStatus()}getHandler(e){if(!(e in this.handlers))throw new A(`There is no handler for '${e}'.`);return this.handlers[e]}async loadProcess(e){let t=new N(this,null);return await t.load(e),t}};c();c();var ce=E(require("express"));c();function ae(n){return{process:{getAll:async()=>n("processes").select("*").orderBy("created","desc"),get:async e=>{let t=await n("processes").select("*").where({id:e}).first();if(t){let r=await n("process_steps").select("id","action","directions","number","started","finished").where({processId:e}).orderBy("number");t.steps=r||[]}return t},getStep:async(e,t)=>await n("process_steps").select("*").where({processId:e,number:t}).first()}}}function Y(n,e){let t=ce.default.Router(),r=ae(n);return t.get("/",async(s,o)=>o.send(await r.process.getAll())),t.get("/:id",async(s,o)=>o.send(await r.process.get(parseInt(s.params.id)))),t.post("/",async(s,o)=>{let d=e(s),{files:l,config:V}=s.body,D=l.map(S=>S.name),f=await d.createProcess(`Uploading files ${D.join(", ")}`,l,{...o.locals.server.configDefaults,...V});return f.canRun()&&await f.run(),o.send(await r.process.get(f.id))}),t.post("/:id",async(s,o)=>{let d=e(s),{id:l}=s.params,V=await d.loadProcess(parseInt(l));await V.input(s.body),V.canRun()&&await V.run(),o.sendStatus(204)}),t.get("/:id/step/:number",async(s,o)=>o.send(await r.process.getStep(parseInt(s.params.id),parseInt(s.params.number)))),t}c();c();var R=E(require("path")),ee=E(require("express")),z=E(require("fs")),we=E(require("knex")),Se=E(ge());var te=class{constructor(e,t,r,s=null,o={}){this.app=(0,ee.default)();this.start=async(e=!1)=>{e&&await this.db.migrate.rollback(),await this.db.migrate.latest();let t=()=>{let r=new H(this.db,this.connector);return this.handlers.forEach(s=>r.register(s)),r};this.app.use((r,s,o)=>{s.locals.server=this,o()}),this.app.use((r,s,o)=>{console.log(new Date,r.method,r.url),o()}),this.app.use((0,Se.default)()),this.app.use(ee.default.json({limit:"1024MB"})),this.app.use("/api/isp",Y(this.db,t)),this.server=this.app.listen(this.port,()=>{console.log(new Date,`Server started on port ${this.port}.`),this.connector.initialize(this)}),this.server.on("error",r=>{console.error(new Date,r)})};this.stop=async(e=void 0)=>{console.log(new Date,"Stopping the server."),await this.server.close(()=>{if(e)throw e;u.default.exit()})};this.port=e,this.configDefaults=o;let d=R.default.normalize(`${__dirname}/migrations/01_init.js`);if(z.default.existsSync(d)||(d=R.default.normalize(`${__dirname}/../../dist/migrations/01_init.js`)),z.default.existsSync(d)||(d=R.default.normalize(`${__dirname}/../../../dist/migrations/01_init.js`)),!z.default.existsSync(d))throw console.log(__dirname),new Error(`Cannot XXX find migrations file '${d}'.`);this.db=(0,we.default)({client:"pg",connection:t,migrations:{directory:R.default.dirname(d)}}),this.handlers=r,s?this.connector=s:this.connector=Q}async lastProcessID(){let e=await this.db("processes").max("id").first();return e?e.max:null}};0&&(module.exports={AskUI,BadState,DatabaseError,Directions,ISPDemoServer,InvalidArgument,InvalidFile,NotFound,NotImplemented,Process,ProcessFile,ProcessHandler,ProcessStep,ProcessingError,ProcessingSystem,SystemError,TextFileProcessHandler,defaultConnector,router});
/*
object-assign
(c) Sindre Sorhus
@license MIT
*/
/*!
 * vary
 * Copyright(c) 2014-2017 Douglas Christopher Wilson
 * MIT Licensed
 */
